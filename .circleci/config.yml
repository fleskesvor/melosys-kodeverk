# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
defaults: &defaults
  docker:
    # specify the version you desire here
    - image: circleci/node:latest

version: 2.1
jobs:
  bygg:
    <<: *defaults
    working_directory: ~/melosys-kodeverk

      # Specify service dependencies here if necessary
      # CircleCI maintains a library of pre-built images
      # documented at https://circleci.com/docs/2.0/circleci-images/
      # - image: circleci/mongo:3.4.4

    steps:
      - checkout
      - run:
          name: Check versions and env
          command: |
              yarn --version
              node --version
              npm --version
              env

      # Download and cache dependencies
      - restore_cache:
          keys:
            - v1-yarn-{{ checksum "yarn.lock" }}
            # fallback to using the latest cache if no exact match is found
            - v1-yarn-

      - run: yarn install

      - save_cache:
          key: v1-yarn-{{ checksum "yarn.lock" }}
          paths:
            - node_modules

      # run tests!
      - run: yarn test
      # run build
      - run: yarn build
      - run:
          name: Publish to NPM
          command: |
            npm version patch -m "%s, Testing autopublishing"
            git config user.email "abjolseth@gmail.com"
            git config user.name "Are Bjølseth"
            git --follow-tags
            npm set //registry.npmjs.org/:_authToken=61ad269e-8b59-4f0d-abc7-5fb1debcf513
            npm publish

      - run:
          name: Debugging dist directory
          command: |
            cd dist
            pwd
            ls -la
            cat ./semver.txt
      # Persisterer dist-katalogen med de genererte filene      
      - persist_to_workspace:
          root: ~/
          paths:
            - melosys-kodeverk
  maven_bygg:
    docker:
      # Henter inn docker-image for melosys-kodeverk-java, som kan generere melosys-internt-kodeverk
      # Bruker eksplisitt referanse, og ikke latest (siden det verken garanterer siste versjon eller bygg som kan rekjøres likt)
      - image: navikt/melosys-kodeverk-java:67088a1d772a1b096033188123102c5db913fb09
    working_directory: ~/melosys-kodeverk-java
    steps:
      # Henter opp den persisterte dist-katalogen
      - attach_workspace:
          at: ~/
      - restore_cache:
          keys:
            - v1-m2build-{{ checksum "/app.jar" }}
            # fallback to using the latest cache if no exact match is found
            - v1-m2build-
      - run:
          name: Generere Java-kodeverk
          command: |
            set -e
            java -jar /app.jar ~/melosys-kodeverk/dist/kodemap.yml
      - run:
          name: Bygge Java-kodeverk
          command: |
            cd melosys-internt-kodeverk
            mvn clean install -B -V
      - save_cache:
          key: v1-m2build-{{ checksum "/app.jar" }}
          paths:
            - ~/.m2
      - persist_to_workspace:
          root: ~/
          paths:
            - melosys-kodeverk-java

  npm_release:
    <<: *defaults
    working_directory: ~/melosys-kodeverk
    steps:
      - attach_workspace:
          at: ~/
      - add_ssh_keys:
          fingerprints:
            - "2a:4c:ad:ed:24:4c:d0:c4:1f:03:86:1b:c8:bd:90:c2"
      - run:
          name: Deployer
          command: |
            echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" >> ~/.npmrc
            echo "github.com ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==" >> ~/.ssh/known_hosts
            git branch --set-upstream-to=origin/$CIRCLE_BRANCH
            git config --global user.email "circleci-melosys@nav.no"
            git config --global user.name "CircleCI"

            if [[ -z "${CIRCLE_TAG}" ]]; then
              if [ "${CIRCLE_BRANCH}" == "master" ]; then
                GIT_COMMIT_DESC=`git log --format=oneline -n 1 $CIRCLE_SHA1`
                npm version patch -m "%s $GIT_COMMIT_DESC [skip ci]"
                git push && git push --tags
                npm run semver
              else
                MELOSYS_KODEVERK_VERSION=`sed 's/\s//g' ~/melosys-kodeverk/dist/semver.txt | tr -d '\n' | sed 's/:/-/g'`
                npm version $MELOSYS_KODEVERK_VERSION -m "%s [skip ci]" --allow-same-version
              fi
            # Fra tag
            else
              npm run semver
            fi
            npm publish --access public
      - persist_to_workspace:
          root: ~/
          paths:
            - melosys-kodeverk/dist
  maven_release:
    docker:
      # Henter inn docker-image for melosys-kodeverk-java, som kan generere melosys-internt-kodeverk
      # Bruker eksplisitt referanse, og ikke latest (siden det verken garanterer siste versjon eller bygg som kan rekjøres)
      - image: navikt/melosys-kodeverk-java:4780adedea5aee744e0622b031877bdf533ae8ce
    working_directory: ~/melosys-kodeverk-java/melosys-internt-kodeverk
    steps:
      # Henter opp den persisterte dist-katalogen
      - attach_workspace:
          at: ~/
      - restore_cache:
          keys:
            - v1-m2release-{{ checksum "~/melosys-kodeverk-java/melosys-internt-kodeverk/pom.xml" }}
            # fallback to using the latest cache if no exact match is found
            - v1-m2release-
      - run:
          name: Hente Maven-avhengigheter
          command: |
            mvn dependency:resolve --settings /settings.xml
            mvn dependency:resolve-plugins --settings /settings.xml
      - save_cache:
          key: v1-m2release-{{ checksum "~/melosys-kodeverk-java/melosys-internt-kodeverk/pom.xml" }}
          paths:
            - ~/.m2
      - run:
          name: Release Java-kodeverk
          command: |
            echo $GPG_KEY_BASE64 | base64 --decode | gpg --yes --batch --import
            MELOSYS_KODEVERK_VERSION=`sed 's/\s//g' ~/melosys-kodeverk/dist/semver.txt | tr -d '\n' | sed 's/:/-/g'`
            mvn versions:set -DnewVersion=$MELOSYS_KODEVERK_VERSION
            mvn -B --settings /settings.xml deploy -Prelease -DskipTests=true
            
workflows:
  version: 2.1
  bygg_og_deploy_master_tags:
    jobs:
      - bygg:
          filters:
            branches:
              only:
                - master
            tags:
              only:
                - /^v.*/
      - maven_bygg:
          requires:
            - bygg
          filters:
            tags:
              only:
                - /^v.*/
      - npm_release:
          requires:
            - maven_bygg
          filters:
            tags:
              only:
                - /^v.*/
      - maven_release:
          context: Maven Central Release
          requires:
            - npm_release
          filters:
            tags:
              only:
                - /^v.*/
  bygg_og_deploy_branch:
    jobs:
      - bygg:
          filters:
            branches:
              ignore:
                - master
      - maven_bygg:
          requires:
            - bygg
      - release:
          type: approval
          requires:
            - maven_bygg
      - npm_release:
          requires:
            - release
      - maven_release:
          context: Maven Central Release
          requires:
            - npm_release
