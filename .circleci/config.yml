# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
defaults: &defaults
  docker:
    # specify the version you desire here
    - image: circleci/node:latest

version: 2.1
jobs:
  bygg:
    <<: *defaults
    working_directory: ~/melosys-kodeverk

      # Specify service dependencies here if necessary
      # CircleCI maintains a library of pre-built images
      # documented at https://circleci.com/docs/2.0/circleci-images/
      # - image: circleci/mongo:3.4.4

    steps:
      - checkout
      - run:
          name: Check versions and env
          command: |
              yarn --version
              node --version
              env
# Yarn
#      - restore_cache:
#        key: yarn-cache-{{ checksum "yarn.lock" }}
#       - run: yarn install && yarn build
#       - save_cache:
#           key: yarn-cache-{{ checksum "yarn.lock" }}
#            paths:
#              - node_modules
#
      # Download and cache dependencies
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package.json" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies-

      - run: yarn install

      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ checksum "package.json" }}

      # run tests!
      - run: yarn test
      # run build
      - run: yarn build

      - run:
          name: Debugging dist directory
          command: |
            cd dist
            pwd
            ls -la
            cat ./semver.txt
      # Persisterer dist-katalogen med de genererte filene      
      - persist_to_workspace:
          root: ~/
          paths:
            - melosys-kodeverk
  maven_bygg:
    docker:
      # Henter inn docker-image for melosys-kodeverk-java, som kan generere melosys-internt-kodeverk
      # Bruker eksplisitt referanse, og ikke latest (siden det verken garanterer siste versjon eller bygg som kan rekjøres likt)
      - image: navikt/melosys-kodeverk-java:bd59613917c17c54f33fd0e93b61093ebd3092e3
    working_directory: ~/melosys-kodeverk-java
    steps:
      # Henter opp den persisterte dist-katalogen
      - attach_workspace:
          at: ~/
      - run:
          name: Bygge Java-kodeverk
          command: |
            set -e
            java -jar /app.jar ~/melosys-kodeverk/dist/semver.txt ~/melosys-kodeverk/dist/kodemap.yml
            cd melosys-internt-kodeverk
            mvn clean install -B -V
      - persist_to_workspace:
          root: ~/
          paths:
            - melosys-kodeverk-java/melosys-internt-kodeverk

  npm_release:
    <<: *defaults
    working_directory: ~/melosys-kodeverk
    steps:
      - attach_workspace:
          at: ~/
      - add_ssh_keys:
          fingerprints:
            - "2a:4c:ad:ed:24:4c:d0:c4:1f:03:86:1b:c8:bd:90:c2"
      - run:
          name: Deployer
          command: |
            echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" >> ~/.npmrc
            echo "github.com ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==" >> ~/.ssh/known_hosts
            git branch --set-upstream-to=origin/$CIRCLE_BRANCH
            git config --global user.email "circleci-melosys@nav.no"
            git config --global user.name "CircleCI"            
            npm version patch -m "%s MELOSYS-xxxx"
            git push && git push --tags
            npm publish --access public
            npm run semver
            cat ~/melosys-kodeverk/dist/semver.txt
          
      - persist_to_workspace:
          root: ~/
          paths:
            - melosys-kodeverk/dist
  maven_release:
    docker:
      # Henter inn docker-image for melosys-kodeverk-java, som kan generere melosys-internt-kodeverk
      # Bruker eksplisitt referanse, og ikke latest (siden det verken garanterer siste versjon eller bygg som kan rekjøres)
      - image: navikt/melosys-kodeverk-java:bd59613917c17c54f33fd0e93b61093ebd3092e3
    working_directory: ~/melosys-kodeverk-java
    steps:
      # Henter opp den persisterte dist-katalogen
      - attach_workspace:
          at: ~/
      - run:
          name: Release Java-kodeverk
          command: |
            cat ~/melosys-kodeverk/dist/semver.txt
            cd melosys-internt-kodeverk
            echo $GPG_KEY_BASE64 | base64 --decode | gpg --yes --batch --import
            MELOSYS_KODEVERK_VERSION=`sed 's/\s//g' ~/melosys-kodeverk/dist/semver.txt | tr -d '\n' | sed 's/:/-/g'`
            mvn versions:set -DnewVersion=$MELOSYS_KODEVERK_VERSION -B -V -e --settings /settings.xml deploy -Prelease -DskipTests=true
            
workflows:
  version: 2.1
  bygg_og_deploy:
    jobs:
      - bygg:
          filters:
            tags:
              ignore: /.*/
      - maven_bygg:
          requires:
            - bygg
      - release:
          type: approval
          requires:
            - maven_bygg
      - npm_release:
          requires:
            - release
#          filters:
#            branches:
#              only:
#                - master
      - maven_release:
          context: Maven Central Release
          requires:
            - npm_release
#          filters:
#            branches:
#              only:
#                - master
